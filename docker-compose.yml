# Instagram Menü Otomasyon - Docker Compose
# n8n + Python API birlikte çalışır

services:
  # ============================================
  # Python API Servisi
  # ============================================
  python-api:
    build:
      context: ./3_scripts
      dockerfile: Dockerfile
    container_name: menu-api
    ports:
      - "8000:8000"
    volumes:
      # Assets (template görseller)
      - ./2_assets:/app/assets:ro
      # Output (oluşturulan görseller)
      - ./output:/app/output
    environment:
      - PYTHONUNBUFFERED=1
      - ASSETS_DIR=/app/assets
      - OUTPUT_DIR=/app/output
      # ÖNEMLİ: VPS'te bu değeri gerçek IP/domain ile değiştirin
      # Instagram API bu URL'den görseli çekecek
      - API_BASE_URL=http://host.docker.internal:8000
      # ImgBB API Key - https://api.imgbb.com/ adresinden alın
      - IMGBB_API_KEY=${IMGBB_API_KEY:-}
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # n8n Otomasyon Servisi
  # ============================================
  n8n:
    image: docker.n8n.io/n8nio/n8n
    container_name: n8n
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=macskulubu2025
      - GENERIC_TIMEZONE=Europe/Istanbul
      - TZ=Europe/Istanbul
    networks:
      - app-network
    depends_on:
      python-api:
        condition: service_healthy
    restart: unless-stopped

# ============================================
# Network
# ============================================
networks:
  app-network:
    driver: bridge

# ============================================
# Volumes
# ============================================
volumes:
  n8n_data:
    driver: local
